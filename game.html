<html>
<head>
	<title>Dead Hunting</title>
	<link rel="stylesheet" href="css/game.css">
	<link rel="stylesheet" href="js/sweetalert-master/sweetalert.css">
	<script type="text/javascript" src="js/sweetalert-master/sweetalert-dev.js"></script>
	<script type="text/javascript" src="js/jquery-3.1.1.min.js"></script>
	<script type="text/javascript" src="js/three.js"></script>
	<script src="http://mamboleoo.be/learnThree/demos/OBJLoader.js"></script>
	<style>
	@font-face {
		font-family: DeadKansas;
		src: url(font/DeadKansas.ttf);
		font-weight: bold;
	}
</style>
	<script type="text/javascript">


	var scene;
	var camera;
	var renderer;

	var cube1;
	var sky;
	var ambientLight;
	var directionalLight;
	
	var zombies = [];
	var balas = [];
	var posXJugador = 1;
	var posYJugador = 0;
	var posZJugador = 15;
	var fired = false;
	var vida = 100;
	var id = 0;
	var score = 0;
	var jugador;
	
	$(document).ready(function() {

		var visibleSize = {
			width: window.innerWidth,
			height: window.innerHeight
		};
		scene = new THREE.Scene();
		
		// Camara
		camera = new THREE.PerspectiveCamera(75, visibleSize.width / visibleSize.height, 0.1, 100000);
		camera.position.z = 17;
		camera.position.y = 5;
		camera.rotation.x = de2ra(-35);


		renderer = new THREE.WebGLRenderer({ 
			precision: "mediump" 
		});

		renderer.setClearColor(new THREE.Color(0,0,0));
		renderer.setSize(visibleSize.width, visibleSize.height);
		renderer.setPixelRatio(visibleSize.width / visibleSize.height);

		renderer.shadowMapEnabled = true;
		renderer.shadowMapSoft = true;

		renderer.shadowCameraNear = 3;
		renderer.shadowCameraFar = camera.far;
		renderer.shadowCameraFov = 50;

		renderer.shadowMapBias = 0.0039;
		renderer.shadowMapDarkness =1;
		renderer.shadowMapWidth = 1024;
		renderer.shadowMapHeight = 1024;


		// Luces
		initLights();		
		
		// Skydome
		var skyGeo = new THREE.SphereGeometry(100, 25, 25); 
		var texture = THREE.ImageUtils.loadTexture( "assets/textures/skydome.jpg" );
		var material2 = new THREE.MeshPhongMaterial({ 
			map: texture
		});
		sky = new THREE.Mesh(skyGeo, material2);
		sky.material.side = THREE.BackSide;
		scene.add(sky);
		
		// Piso		
		var geometry = new THREE.PlaneGeometry( 500, 500, 1, 1);
		var grassTexture = THREE.ImageUtils.loadTexture( "assets/textures/grass.jpg" );
		grassTexture.wrapS = grassTexture.wrapT = THREE.RepeatWrapping; 
		grassTexture.repeat.set( 100, 100 );
		var grassMaterial = new THREE.MeshLambertMaterial({ 
			map: grassTexture,
			side: THREE.DoubleSide
		});



		var plane = new THREE.Mesh( geometry, grassMaterial);
		plane.rotation.x = de2ra(90);
		plane.receiveShadow = true;
		scene.add( plane );
		
		// Objetos
		var material = new THREE.MeshLambertMaterial ({
			color: new THREE.Color(0.4, 0, 0)
		});

		var geometry = new THREE.BoxGeometry(1, 1, 1);
		cube1 = new THREE.Mesh( new THREE.CubeGeometry( 1, 1, 1 ), new THREE.MeshNormalMaterial() );
		cube1.position.x = posXJugador;	
		cube1.position.y = posYJugador;
		cube1.position.z = posZJugador;
		cube1.castShadow = true;
		scene.add(cube1);
	
		addModel("assets/models/soldier/soldier.obj","assets/models/dog/Tex_0552_7.png","jugador");
		
		

		scene.add(ambientLight);
		scene.add(directionalLight);

		//agregamos el canvas
		$("#scene-section").append(renderer.domElement);		
		
		render();
		
		setInterval(spawnZombie, 2000);
		
		$('body').mousedown(function(event) {
		switch (event.which) {
        case 1:
            //alert('Left Mouse button pressed.');
			spawnBullet();
            break;
        case 3:
            //alert('Right Mouse button pressed.');
            break;
    }
});
		
	});
	
	function spawnBullet(){
		addModel("assets/models/bullet/bullet.obj","assets/models/dog/Tex_0552_7.png","bullet");
		
	}
	
	function spawnZombie() {	
		addModel("assets/models/zombie/zombie.obj","assets/models/dog/Tex_0552_7.png","zombie");
		
	}
	
	function de2ra(degree)   { 
		return degree*(Math.PI/180); 
	}
	
	function addModel(objPath, texturePath, name){
		var manager = new THREE.LoadingManager();
		manager.onProgress = function ( item, loaded, total ) {
			console.log( item, loaded, total );
		};

		var texture = new THREE.Texture();
		var onProgress = function ( xhr ) {
			if ( xhr.lengthComputable ) {
				var percentComplete = xhr.loaded / xhr.total * 100;
				console.log( Math.round(percentComplete, 2) + '% downloaded' );
			}
		};

		var onError = function ( xhr ) {
		};

		var loader = new THREE.ImageLoader( manager );
		loader.load( texturePath, function ( image ) {

			texture.image = image;
			texture.needsUpdate = true;

		} );

		// model

		var loader = new THREE.OBJLoader( manager );
		loader.load( objPath, function ( object ) {

			object.traverse( function ( child ) {
				if ( child instanceof THREE.Mesh ) {
					child.material.map = texture;
				}
			});
			
			object.position.x = posXJugador;
			object.position.y = posYJugador;
			object.position.z = posZJugador;
			
			object.name = name;

			if(name == "jugador"){
				object.scale.set(0.01,0.01,0.01);
				object.rotation.y = de2ra(180);
				jugador = object.clone();
				scene.add( jugador );
			}

			if(name == "zombie"){
				object.scale.set(0.015,0.015,0.015);
				var cube2 = object.clone();
				cube2.castShadow = true;
				var num = Math.floor(Math.random()*3) + 1; // this will get a number between 1 and 99;		
				num *= Math.floor(Math.random()*2) == 1 ? 1 : -1; // this will add minus sign in 50% of cases		
				cube2.position.x = num;
				cube2.position.z = -5;
				id++;
				cube2.name = id;
				zombies.push(cube2);		
				scene.add(cube2);
			}

			if(name == "bullet"){
				object.rotation.y = de2ra(-180);
				object.scale.set(0.015,0.015,0.015);
				var cube2 = object.clone();		
				cube2.position.x = posXJugador;
				cube2.position.y = posYJugador;
				cube2.position.z = posZJugador;
				id++;
				cube2.name = id;
				balas.push(cube2);		
				scene.add(cube2);
			}

			
		}, onProgress, onError );
	}
	
	function initLights(){
		ambientLight = new THREE.AmbientLight(
			new THREE.Color(1, 1, 1),
			1.0
		);
		
		directionalLight = new THREE.DirectionalLight(
			new THREE.Color(1, 1, 1),
			0.4
		);

		var d = 15;
	    directionalLight.castShadow = true;
	    directionalLight.shadowCameraVisible = true;
	    directionalLight.position.set(10, 10, -10);
	    directionalLight.target.position.set(0, 0, 0);

	    directionalLight.shadowCameraNear = 2;
		directionalLight.shadowCameraFar = 5;
		directionalLight.shadowCameraLeft = -d;
		directionalLight.shadowCameraRight = d;
		directionalLight.shadowCameraTop = d;
		directionalLight.shadowCameraBottom = -d;

	    directionalLight.shadowCameraFar = 1000;
	    directionalLight.shadowDarkness = 0.5;

		
			
	}
	

	function render() {
		requestAnimationFrame(render);
		
		zombies = zombies.filter(function( element ) {
		   return element !== undefined;
		});
		
		balas = balas.filter(function( element ) {
		   return element !== undefined;
		});
		
		// Deteccion de colision bala-zombie
		for (var i = 0; i < zombies.length; i++){
			for (var j = 0; j < balas.length; j++){
				if(zombies[i].position.x == balas[j].position.x && zombies[i].position.z >= balas[j].position.z){
					scene.remove(scene.getObjectByName(zombies[i].name));
					scene.remove(scene.getObjectByName(balas[j].name));
					delete zombies[i];
					delete balas[j];
					score+=10;
					$(".numScore").text(score);
					$( ".numScore" ).animate({
					    fontSize: 40
					  }, 25, function() {
						    $( ".numScore" ).animate({
						    fontSize: 30
						  }, 25, function() {
						    // Animation complete.
						  });
					  });

				}	
			}	
		}

		zombies = zombies.filter(function( element ) {
		   return element !== undefined;
		});
		
		balas = balas.filter(function( element ) {
		   return element !== undefined;
		});
		
		// Movimiento de zombies
		for (var i = 0; i < zombies.length; i++){
			if(zombies[i].position.z < posZJugador - 1){
				zombies[i].position.z += 0.1;
			}
			
			if(zombies[i].position.z + 1 >= posZJugador){
				var vidaSize = $(".vida").css("width");
				vidaSize = vidaSize.replace(/\D/g,'');
				$(".vida").css("width", vidaSize - 1);

				if (vidaSize-1 <= 0){
						if(localStorage.usuario == "" || localStorage.usuario == null){
							swal({
							  title: "SCORE: " + score,
							  type: "input",
							  closeOnConfirm: false,
							  animation: "slide-from-top",
							  inputPlaceholder: "Nombre"
							},
							function(inputValue){
							  if (inputValue === false) return false;
							  
							  if (inputValue === "") {
							    swal.showInputError("You need to write something!");
							    return false
							  }
							  
							  swal("Nice!", "You wrote: " + inputValue, "success");
							});
						}	
				}
			}
			
		}
		
		// Impulso de la bala
		for (var i = 0; i < balas.length; i++){

			if(balas[i].position.z < -5){
				scene.remove(scene.getObjectByName(balas[i].name));
				delete balas[i];
			}else{
				balas[i].position.z -= 2;
			}

			
		}			

		sky.rotation.y += 0.0005;
		document.addEventListener('keydown',onDocumentKeyDown,false);
		function onDocumentKeyDown(event){
			if(!fired) {
				fired = true;
			var delta = 0.005;
			event = event || window.event;
			var keycode = event.keyCode;
			switch(keycode){
				case 37 : //left arrow
					cube1.position.x -= 1;
					jugador.position.x -= 1;
					posXJugador = cube1.position.x;
					//camera.position.x = camera.position.x - delta;
				break;
				case 39 : // right arrow
					cube1.position.x += 1;	
					jugador.position.x += 1;

					posXJugador = cube1.position.x;
					//camera.position.x = camera.position.x + delta;
				break;
			}	
			
			
			if(cube1.position.x > 3){
				cube1.position.x = 3;
				posXJugador = 3;
				jugador.position.x = 3;

			}
			
			if(cube1.position.x < -3){
				posXJugador = -3;
				cube1.position.x = -3;
				jugador.position.x = -3;

			}
			
			document.addEventListener('keyup',onDocumentKeyUp,false);
			console.log("x: "+ cube1.position.x);

		}
		}
	

	function onDocumentKeyUp(event){
		document.removeEventListener('keydown',onDocumentKeyDown,false);
		fired = false;
	}
		renderer.render(scene, camera);
	}
	
	function removeEntity(object) {
		var selectedObject = scene.getObjectByName(object.name);
		scene.remove( selectedObject );
		animate();
	}	
	
	</script>
</head>
<body>
	<div id="scene-section"/>
	<div class="vida"></div>
	<div class="score">Score    <div class="numScore"></div></div>
</body>
</html>